<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Temp Title</title>
	<script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>

	<link rel="stylesheet" href="https://cdn.datatables.net/2.0.4/css/dataTables.dataTables.css" />
	<script src="https://cdn.datatables.net/2.0.4/js/dataTables.js"></script>

	<!--<script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.3/css/dataTables.js"></script>-->
</head>

<style>
	.section {
		margin: 10px;
		background-color: #181818;
		border-radius: 5px;
		padding: 10px;
	}

	.plotly-graph {
		margin: 10px;
		padding: 10px;
		width: 80%;
		height: 10%;
	}
</style>

<body>
	<div class="section">
		<h1>Server Connection</h1>
		<p>Address:</p>
		<input type="text" id="host" value="127.0.0.1">
		<p>Port:</p>
		<input type="text" id="port" value="6969">
		<p>Repository URL:</p>
		<input type="text" id="repo" value=""> <br>
		<button onclick="startSocketConnection()">Connect to server</button>
	</div>

	<div class="section">
		<h1>Leaderboard</h1>
		<table id="LeaderboardTable">
			<thead>
				<tr>
					<th>Identifier</th>
					<th>First iteration</th>
					<th>Accumulated</th>
					<th>Per Call</th>
				</tr>
			</thead>
			<tbody id="LeaderboardRows">
			</tbody>
		</table>
	</div>

	<div class="section">
		<H1>Graphs</H1>
		<div id="graphs"></div>
	</div>

	<script>
		const vscode = acquireVsCodeApi();

		function startSocketConnection() {
			const host = document.getElementById("host").value;
			const port = document.getElementById("port").value;
			const repo = document.getElementById("repo").value;

			vscode.postMessage({
				command: 'startSocket',
				host: host,
				port: port,
				repo: repo
			})
		}

		//Does not have to be a dictionary
		var plots = {};


		function addGraph(id) {
			let newHeader = document.createElement('h2');
			newHeader.innerHTML = id;

			const graphDiv = document.getElementById("graphs");

			graphDiv.appendChild(newHeader);

			let newTable = document.createElement('table');
			newTable.id = id + "Table";
			newTable.innerHTML = "<tr><th>First iteration</th><th>Accumulated</th><th>Per Call</th></tr>"
			let newRow = newTable.insertRow(1);
			newRow.id = id + "Row";
			let newCell1 = newRow.insertCell(0);
			newCell1.id = id + "Cell1";
			newCell1.innerHTML = "0";
			let newCell2 = newRow.insertCell(1);
			newCell2.id = id + "Cell2";
			newCell2.innerHTML = "0";
			let newCell3 = newRow.insertCell(2);
			newCell3.id = id + "Cell3";
			newCell3.innerHTML = "0";
			graphDiv.appendChild(newTable);


			let newDiv = document.createElement('div');
			newDiv.id = id;
			newDiv.className = "plotly-graph";
			graphDiv.appendChild(newDiv);

			const layout = {
				autosize: true,
				title: id,
				xaxis: {
					title: 'Call count' // todo better name
				},
				yaxis: {
					title: 'PKG'
				}
			};

			plots.id = (Plotly.newPlot(id, [{ y: [], mode: 'scatter', line: { color: '#80CAF6' } }], layout))
		}

		function UpdateStats(id, first, acc, per_call) { //TODO just get table once and update values
			let cell1 = document.getElementById(id + "Cell1");
			cell1.innerHTML = first;
			let cell2 = document.getElementById(id + "Cell2");
			cell2.innerHTML = acc;
			let cell3 = document.getElementById(id + "Cell3");
			cell3.innerHTML = per_call;
		}

		function UpdateLeaderBoardData(id, first, acc, per_call) {
			let newRow = document.createElement("tr");
			newRow.id = id + "Row";
			let newCell1 = newRow.insertCell(0);
			newCell1.id = id + "Cell1";
			newCell1.innerHTML = id;
			let newCell2 = newRow.insertCell(1);
			newCell2.id = id + "Cell2";
			newCell2.innerHTML = first;
			let newCell3 = newRow.insertCell(2);
			newCell3.id = id + "Cell3";
			newCell3.innerHTML = acc;
			let newCell4 = newRow.insertCell(3);
			newCell4.id = id + "Cell4";
			newCell4.innerHTML = per_call;
			document.getElementById("LeaderboardRows").appendChild(newRow);
		}

		function UpdateLeaderboard(dict) {

			for (const [key, value] of Object.entries(dict)) {
				console.log(key, value);
				UpdateLeaderBoardData(value[3], value[0], value[1], ((value[1]) / (value[2])));
			}

			let table = new DataTable('#LeaderboardTable', {
				//Opions
			});
		}

		// Handle the message inside the webview
		window.addEventListener('message', event => {

			const message = event.data; // The JSON data our extension sent

			switch (message.command) {
				case 'updateGraph':
					Plotly.extendTraces(message.id, {
						y: [[message.value]]
					}, [0]);
					break;

				case 'addGraph':
					addGraph(message.id);
					break;

				case 'updateStats':
					UpdateStats(message.id, message.first, message.acc, message.per_call);
					break;

				case 'SocketClosed':
					UpdateLeaderboard(message.dict);
			}
		});

	</script>

</body>

</html>